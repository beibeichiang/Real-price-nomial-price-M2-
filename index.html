<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­ç¾æ ¸å¿ƒèµ„äº§ vs M2ï¼šç»ˆæå¯¹å†³ (2025ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: #2563EB; cursor: pointer; border-radius: 50%;
        }
        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        
        .radio-label input:checked + div {
            background-color: #EFF6FF; border-color: #2563EB; color: #1E40AF;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid #2563EB;
            color: #1D4ED8;
            background-color: #EFF6FF;
        }
        
        /* Custom scrollbar for info box */
        #infoContainer::-webkit-scrollbar { width: 4px; }
        #infoContainer::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center min-h-screen p-2 md:p-4">

    <!-- Header -->
    <header class="w-full max-w-7xl mb-4 text-center">
        <h1 class="text-xl md:text-3xl font-bold text-gray-900 mb-1">ä¸­ç¾èµ„äº§å¤§ä¹±æ–— (1980-2025)</h1>
        <p class="text-xs md:text-sm text-gray-500">
            <span class="bg-yellow-100 text-yellow-800 px-1 rounded">Update</span> æ–°å¢BTCå‡åŠå‘¨æœŸçº¿
            | <span class="font-bold text-red-600">å¼ºçƒˆå»ºè®®å¼€å¯â€œå¯¹æ•°åæ ‡â€éªŒè¯å‘¨æœŸè®º</span>
        </p>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-7xl bg-white rounded-xl shadow-lg overflow-hidden">
        
        <!-- Country Tabs -->
        <div class="flex border-b border-gray-200">
            <button onclick="switchCountry('cn')" id="tab-cn" class="tab-btn active flex-1 py-4 text-center font-bold text-gray-500 hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                <span class="text-xl">ğŸ‡¨ğŸ‡³</span> ä¸­å›½ (1998-2025)
            </button>
            <button onclick="switchCountry('us')" id="tab-us" class="tab-btn flex-1 py-4 text-center font-bold text-gray-500 hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                <span class="text-xl">ğŸ‡ºğŸ‡¸</span> ç¾å›½ (1980-2025)
            </button>
        </div>

        <div class="p-3 md:p-5">
            <!-- Controls -->
            <div class="mb-5 grid grid-cols-1 lg:grid-cols-3 gap-4">
                
                <!-- Inflation Model -->
                <div class="col-span-1 lg:col-span-2 bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">é€‰æ‹©â€œæŠ˜ç®—æ ‡å‡†â€ (å»é™¤æ°´åˆ†)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <label class="radio-label cursor-pointer relative">
                            <input type="radio" name="infMode" value="cpi" class="sr-only" onchange="switchMode('cpi')">
                            <div class="border border-gray-300 rounded-md p-3 hover:bg-gray-50 h-full flex flex-col justify-between">
                                <span class="font-bold text-sm">å®˜æ–¹ CPI</span>
                                <p class="text-xs text-gray-500 mt-1">ä»…æ¶ˆè´¹å“ï¼Œé€šå¸¸ä½ä¼°ã€‚</p>
                            </div>
                        </label>
                        <label class="radio-label cursor-pointer relative">
                            <input type="radio" name="infMode" value="custom" class="sr-only" checked onchange="switchMode('custom')">
                            <div class="border border-gray-300 rounded-md p-3 hover:bg-gray-50 h-full flex flex-col justify-between">
                                <span class="font-bold text-sm">è‡ªå®šä¹‰å›ºå®šå€¼</span>
                                <p class="text-xs text-gray-500 mt-1">æ¨¡æ‹Ÿä½“æ„Ÿé€šèƒ€ã€‚</p>
                            </div>
                        </label>
                        <label class="radio-label cursor-pointer relative">
                            <input type="radio" name="infMode" value="m2" class="sr-only" onchange="switchMode('m2')">
                            <div class="border border-gray-300 rounded-md p-3 hover:bg-gray-50 h-full flex flex-col justify-between bg-purple-50 border-purple-200">
                                <span class="font-bold text-sm text-purple-700">M2 å°é’é€Ÿåº¦</span>
                                <p class="text-xs text-gray-500 mt-1 text-purple-600">èµ„äº§çš„ç»ˆææµ‹è¯•ã€‚è·‘èµ¢å®ƒæ‰ç®—çœŸèµšé’±ã€‚</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Slider / Log -->
                <div class="col-span-1 bg-gray-50 border border-gray-200 rounded-lg p-3 flex flex-col justify-between">
                    <div id="sliderContainer">
                        <label class="block text-sm font-medium text-gray-700 mb-2 flex justify-between">
                            <span>è‡ªå®šä¹‰é€šèƒ€ç‡</span>
                            <span id="inflationValue" class="font-bold text-blue-600">5.5%</span>
                        </label>
                        <input type="range" id="inflationSlider" min="0" max="20" step="0.1" value="5.5" 
                               class="w-full h-2 bg-blue-200 rounded-lg slider-thumb">
                    </div>
                    <div id="infoContainer" class="hidden text-xs text-gray-500 p-2 bg-white rounded border overflow-y-auto h-20"><p id="infoText"></p></div>
                    
                    <div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-200 bg-yellow-50 p-2 rounded">
                        <div class="flex items-center">
                            <span class="text-sm font-bold text-gray-800 mr-2">å¼€å¯å¯¹æ•°åæ ‡</span>
                            <div class="relative inline-block w-10 align-middle select-none">
                                <input type="checkbox" id="logScaleToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                <label for="logScaleToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        
                         <div class="flex items-center">
                            <span class="text-sm font-bold text-orange-600 mr-2">æ˜¾ç¤ºBTCå‡åŠ</span>
                            <div class="relative inline-block w-10 align-middle select-none">
                                <input type="checkbox" id="halvingToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                <label for="halvingToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Asset Toggles (New Feature) -->
            <div id="assetToggles" class="mb-4 flex flex-wrap gap-2 text-sm select-none">
                <!-- Dynamically populated checkboxes -->
            </div>

            <!-- Chart Container -->
            <div class="relative h-[450px] md:h-[600px] w-full">
                <canvas id="housingChart"></canvas>
            </div>

            <!-- Legend -->
            <div class="mt-4 flex flex-wrap justify-center gap-4 text-xs text-gray-500" id="customLegend">
                <!-- Dynamically populated -->
            </div>

            <!-- Analysis Box -->
            <div class="mt-5 p-4 bg-gray-100 rounded-lg border border-gray-300 text-sm">
                <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <span id="analysisIcon">ğŸ“Š</span> 
                    <span id="analysisTitle">æ•°æ®è§£è¯» (Crypto Insight)</span>
                </h3>
                <div id="analysisContent" class="text-gray-700 space-y-2 leading-relaxed">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // 1. DATA REPOSITORY (1980-2025)
        // ==========================================
        const years = Array.from({length: 46}, (_, i) => 1980 + i);

        // Helper: Pad CN data (starts 1998, index 18)
        function padCN(dataArr) {
            const padded = new Array(18).fill(null);
            return padded.concat(dataArr);
        }

        // --- CHINA DATA (1998-2025) ---
        const cnDataRaw = {
            m2: [10.4, 11.9, 13.5, 15.8, 18.5, 22.1, 25.3, 29.8, 34.6, 40.3, 47.5, 60.6, 72.6, 85.2, 97.4, 110.6, 122.8, 139.2, 155.0, 167.7, 182.7, 198.6, 218.7, 238.3, 266.4, 292.3, 309.0, 335.0],
            cpi: [-0.8, -1.4, 0.4, 0.7, -0.8, 1.2, 3.9, 1.8, 1.5, 4.8, 5.9, -0.7, 3.3, 5.4, 2.6, 2.6, 2.0, 1.4, 2.0, 1.6, 2.1, 2.9, 2.5, 0.9, 2.0, 0.2, 0.3, 1.0],
            bj: [2000, 2300, 2800, 3200, 3600, 3900, 4500, 5800, 7800, 11000, 12500, 16000, 22000, 26000, 28000, 34000, 38000, 42000, 55000, 60000, 58000, 59000, 61000, 67000, 64000, 61000, 56000, 54000],
            sh: [2300, 2450, 2900, 3500, 4200, 5100, 6500, 8800, 10500, 13000, 14500, 18000, 23000, 25500, 27000, 32000, 37000, 46000, 58000, 62000, 61000, 62000, 66000, 73000, 69000, 65000, 61000, 59000],
            sz: [2800, 3100, 3500, 3800, 4200, 4800, 5500, 7000, 9000, 13000, 12000, 14000, 18000, 19000, 21000, 28000, 45000, 55000, 54000, 56000, 65000, 75000, 82000, 78000, 70000, 65000, 59000, 57000]
        };

        const cnData = {
            m2_totals: padCN(cnDataRaw.m2),
            m2_rates: new Array(18).fill(null).concat([14.8], cnDataRaw.m2.slice(1).map((v, i) => ((v - cnDataRaw.m2[i])/cnDataRaw.m2[i])*100)),
            cpi_rates: new Array(18).fill(null).concat(cnDataRaw.cpi),
            assets: [
                { name: 'åŒ—äº¬æˆ¿ä»·', color: '#2563EB', data: padCN(cnDataRaw.bj), visible: true },
                { name: 'ä¸Šæµ·æˆ¿ä»·', color: '#7C3AED', data: padCN(cnDataRaw.sh), visible: true },
                { name: 'æ·±åœ³æˆ¿ä»·', color: '#DC2626', data: padCN(cnDataRaw.sz), visible: true }
            ],
            unit: 'å…ƒ/å¹³ç±³',
            m2_unit: 'ä¸‡äº¿äººæ°‘å¸',
            desc: 'ä¸­å›½æ•°æ®æ›´æ–°è‡³2025å¹´ã€‚ä¸€çº¿åŸå¸‚æˆ¿ä»·åœ¨2025å¹´å»¶ç»­äº†é˜´è·Œèµ°åŠ¿ï¼Œä¸M2çš„èƒŒç¦»è¿›ä¸€æ­¥æ‹‰å¤§ã€‚è¿™è¡¨æ˜è´§å¸ä¼ å¯¼æœºåˆ¶å·²å˜ï¼Œå¢å‘è´§å¸ä¸å†æ¶Œå…¥æ¥¼å¸‚ï¼Œè€Œæ˜¯æ›´å¤šä½“ç°åœ¨é¿é™©èµ„äº§æˆ–åœ¨é“¶è¡Œä½“ç³»ç©ºè½¬ã€‚'
        };

        // --- US DATA (1980-2025) ---
        const usData = {
            m2_totals: [
                1.6, 1.75, 1.95, 2.18, 2.37, 2.57, 2.81, 2.91, 3.06, 3.22, // 80s
                3.34, 3.44, 3.55, 3.63, 3.68, 3.82, 4.02, 4.22, 4.40, 4.60, // 90s
                4.92, 5.43, 5.78, 6.05, 6.41, 6.68, 7.04, 7.45, 8.16, 8.52, // 00s
                8.82, 9.63, 10.42, 11.05, 11.64, 12.32, 13.19, 13.93, 14.53, 15.32, // 10s
                19.12, 21.43, 21.31, 20.88, 21.10, 21.95 // 20s (2025 Est)
            ],
            cpi_rates: [
                13.5, 10.3, 6.1, 3.2, 4.3, 3.6, 1.9, 3.6, 4.1, 4.8,
                5.4, 4.2, 3.0, 3.0, 2.6, 2.8, 3.0, 2.3, 1.6, 2.2,
                3.4, 2.8, 1.6, 2.3, 2.7, 3.4, 3.2, 2.8, 3.8, -0.4,
                1.6, 3.2, 2.1, 1.5, 1.6, 0.1, 1.3, 2.1, 2.4, 1.8,
                1.2, 4.7, 8.0, 4.1, 3.1, 2.3 // 2025 Est
            ],
            assets: [
                { 
                    name: 'S&P 500', 
                    color: '#16A34A', 
                    visible: true,
                    data: [ 
                        135, 122, 140, 164, 167, 211, 242, 247, 277, 353,
                        330, 417, 435, 466, 459, 615, 740, 970, 1229, 1469,
                        1320, 1148, 879, 1111, 1211, 1248, 1418, 1468, 903, 1115,
                        1257, 1257, 1426, 1848, 2058, 2043, 2238, 2673, 2506, 3230,
                        3756, 4766, 3839, 4769, 5950, 6200 
                    ] 
                },
                {
                    name: 'é»„é‡‘ (Gold)',
                    color: '#EAB308', 
                    visible: false,
                    data: [ 
                        612, 460, 376, 424, 360, 317, 368, 447, 437, 381,
                        383, 362, 343, 359, 384, 384, 387, 331, 294, 278,
                        279, 271, 310, 363, 409, 444, 603, 695, 871, 972,
                        1224, 1571, 1669, 1411, 1266, 1160, 1250, 1257, 1268, 1393,
                        1769, 1798, 1800, 1940, 2350, 2750
                    ]
                },
                {
                    name: 'ç™½é“¶ (Silver)',
                    color: '#94A3B8',
                    visible: false,
                    data: [
                        20.9, 10.5, 7.9, 11.4, 8.1, 6.1, 5.4, 7.0, 6.5, 5.5,
                        4.8, 4.0, 3.9, 4.3, 5.3, 5.2, 5.1, 4.8, 5.5, 5.2,
                        4.9, 4.3, 4.6, 4.8, 6.6, 7.3, 11.5, 13.3, 14.9, 14.6,
                        20.1, 35.1, 31.1, 23.7, 19.0, 15.6, 17.1, 17.0, 15.7, 16.2,
                        20.5, 25.1, 21.7, 23.3, 30.0, 58.0
                    ]
                },
                {
                    name: 'å…¨ç¾æˆ¿ä»·(æŒ‡æ•°)', 
                    color: '#0891B2', 
                    visible: false,
                    data: [
                        650, 690, 710, 750, 800, 850, 920, 1050, 1120, 1200,
                        1250, 1220, 1240, 1280, 1330, 1380, 1420, 1490, 1580, 1650,
                        1720, 1800, 1950, 2100, 2300, 2500, 2400, 2300, 2100, 2200,
                        2250, 2300, 2450, 2650, 2800, 2950, 3100, 3250, 3300, 3350,
                        3400, 3800, 4400, 4200, 4250, 4280
                    ]
                },
                {
                    name: 'Apple (AAPL)',
                    color: '#000000', 
                    visible: true,
                    data: [
                        0.13, 0.09, 0.08, 0.12, 0.10, 0.07, 0.11, 0.15, 0.14, 0.13,
                        0.14, 0.18, 0.20, 0.13, 0.14, 0.15, 0.09, 0.06, 0.15, 0.35,
                        0.38, 0.39, 0.25, 0.33, 0.90, 1.6, 2.3, 5.5, 3.5, 6.5,
                        10.0, 13.0, 17.0, 18.0, 25.0, 27.0, 28.0, 40.0, 38.0, 70.0,
                        130.0, 175.0, 130.0, 190.0, 225.0, 280.0
                    ]
                },
                {
                    name: 'Tesla (TSLA)',
                    color: '#E31937', 
                    visible: true,
                    data: new Array(30).fill(null).concat([
                        1.5, 1.7, 2.0, 6.0, 10.0, 15.0, 14.0, 20.0, 21.0, 28.0, // 2010-2019
                        150.0, 350.0, 120.0, 250.0, 210.0, 350.0 // 2020-2025
                    ])
                },
                {
                    name: 'Nvidia (NVDA)',
                    color: '#76B900', 
                    visible: true,
                    data: new Array(19).fill(null).concat([
                        0.1, 0.2, 0.4, 0.2, 0.3, 0.4, 0.6, 0.8, 1.0, 0.5, // 1999-2008
                        0.8, 1.0, 0.9, 0.8, 1.0, 1.2, 2.0, // 2009-2015
                        6.0, 10.0, 7.0, 15.0, 35.0, 80.0, 40.0, 120.0, 150.0, 180.0 // 2016-2025
                    ])
                },
                {
                    name: 'BTC (æ¯”ç‰¹å¸)',
                    color: '#F97316', 
                    visible: true,
                    data: new Array(30).fill(null).concat([
                        0.1, 5, 13, 700, 320, 430, 960, 14000, 3700, 7200,
                        29000, 47000, 16000, 42000, 95000, 145000
                    ])
                }
            ],
            unit: 'ä»·æ ¼/ç‚¹æ•°',
            m2_unit: 'ä¸‡äº¿ç¾å…ƒ',
            desc: '<ul class="list-disc pl-4 space-y-1"><li><strong>BTC (æ©™çº¿) çš„â€œåŒé‡å±æ€§â€ï¼š</strong>æ­£å¦‚æ‚¨æ‰€è¨€ï¼ŒBTCç»“åˆäº†é»„é‡‘çš„æŠ—é€šèƒ€æ€§ä¸ç§‘æŠ€è‚¡çš„é«˜æˆé•¿æ€§ã€‚å¼€å¯â€œBTCå‡åŠâ€å¼€å…³åå¯ä»¥çœ‹åˆ°ï¼Œæ¯éš”4å¹´çš„ç«–çº¿å‡ ä¹éƒ½æ˜¯æ–°ä¸€è½®è¡Œæƒ…çš„èµ·è·‘æªï¼Œè¿™ç§ç¨‹åºåŒ–çš„ä¾›åº”å‡åŠå¸¦æ¥äº†æ¯”Tesla/Nvidiaæ›´å¼ºçš„å‘¨æœŸç¡®å®šæ€§ã€‚</li><li><strong>Tesla vs BTCï¼š</strong>è™½ç„¶ä¸¤è€…éƒ½æ˜¯é«˜è´å¡”èµ„äº§ï¼Œä½†Teslaæåº¦ä¾èµ–é©¬æ–¯å…‹çš„ä¸ªäººå†³ç­–å’Œå­£åº¦è´¢æŠ¥ï¼Œè€ŒBTCçš„ä¸Šæ¶¨æ›´åƒæ˜¯å¯¹å…¨çƒæ³•å¸è´¬å€¼çš„è¢«åŠ¨å“åº”ï¼Œå› æ­¤é•¿æœŸçœ‹BTCçš„â€œåè„†å¼±æ€§â€æ›´å¼ºã€‚</li></ul>',
            // Define Halving Dates for annotation
            halvingDates: [2012, 2016, 2020, 2024]
        };
        
        // Calc US M2 Rates
        usData.m2_rates = [0]; 
        for(let i=1; i<usData.m2_totals.length; i++) {
            usData.m2_rates.push( ((usData.m2_totals[i] - usData.m2_totals[i-1])/usData.m2_totals[i-1]) * 100 );
        }

        // ==========================================
        // 2. STATE & LOGIC
        // ==========================================
        let currentCountry = 'cn'; 
        let currentMode = 'custom'; 
        let chartInstance = null;

        function switchCountry(code) {
            currentCountry = code;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${code}`).classList.add('active');
            
            // Show/Hide Halving Toggle based on country
            const halvingContainer = document.getElementById('halvingToggle').closest('.flex');
            if(code === 'us') {
                halvingContainer.style.display = 'flex';
            } else {
                halvingContainer.style.display = 'none';
            }
            
            renderToggles();
            updateChart();
        }

        function switchMode(mode) {
            currentMode = mode;
            const slider = document.getElementById('sliderContainer');
            const info = document.getElementById('infoContainer');
            const infoText = document.getElementById('infoText');

            if (mode === 'custom') {
                slider.classList.remove('hidden');
                info.classList.add('hidden');
            } else {
                slider.classList.add('hidden');
                info.classList.remove('hidden');
                infoText.innerHTML = mode === 'cpi' 
                    ? `ä½¿ç”¨${currentCountry.toUpperCase()}å®˜æ–¹CPIæ•°æ®ã€‚<br>ä»…åæ˜ åŸºæœ¬ç”Ÿæ´»ç‰©ä»·ã€‚`
                    : `ä½¿ç”¨${currentCountry.toUpperCase()} M2å¹¿ä¹‰è´§å¸å¢é€Ÿã€‚<br>è¿™æ˜¯"èµ„äº§ä¿å€¼"çš„ç»ˆæåŠæ ¼çº¿ã€‚`;
            }
            updateChart();
        }

        function renderToggles() {
            const data = currentCountry === 'cn' ? cnData : usData;
            const container = document.getElementById('assetToggles');
            container.innerHTML = '';
            
            data.assets.forEach((asset, index) => {
                const id = `toggle_${index}`;
                const wrapper = document.createElement('div');
                wrapper.className = "flex items-center mr-4 mb-2";
                
                wrapper.innerHTML = `
                    <input type="checkbox" id="${id}" ${asset.visible ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 cursor-pointer">
                    <label for="${id}" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer flex items-center select-none">
                        <span class="w-3 h-3 rounded-full mr-1 inline-block" style="background-color:${asset.color}"></span>
                        ${asset.name}
                    </label>
                `;
                
                wrapper.querySelector('input').addEventListener('change', (e) => {
                    data.assets[index].visible = e.target.checked;
                    updateChart();
                });
                
                container.appendChild(wrapper);
            });
        }

        function calculateRealPrices(priceArray, inflationRates) {
            const len = priceArray.length;
            const adjusted = new Array(len).fill(null);
            
            let lastIdx = len - 1;
            while(lastIdx >= 0 && priceArray[lastIdx] === null) lastIdx--;
            if(lastIdx < 0) return adjusted;

            let factor = 1.0;
            adjusted[lastIdx] = priceArray[lastIdx];

            for (let i = lastIdx - 1; i >= 0; i--) {
                if (priceArray[i] === null) continue;
                let rate = 0;
                if(inflationRates[i+1] !== null) {
                    rate = inflationRates[i+1] / 100.0;
                }
                factor = factor * (1 + rate);
                adjusted[i] = priceArray[i] * factor;
            }
            return adjusted;
        }

        // ==========================================
        // 3. CHART RENDERING
        // ==========================================
        function initChart() {
            const ctx = document.getElementById('housingChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e5e7eb', borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const data = currentCountry === 'cn' ? cnData : usData;
                                    if (context.dataset.yAxisID === 'y1') {
                                        return `M2æ€»é‡: ${context.raw.toLocaleString()} ${data.m2_unit}`;
                                    }
                                    let val = context.raw;
                                    if(val > 1000) val = Math.round(val).toLocaleString();
                                    else if(val) val = val.toFixed(2);
                                    
                                    let suffix = '';
                                    if(context.dataset.label.includes('æˆ¿ä»·') && currentCountry === 'us') suffix = ' (æŒ‡æ•°)';
                                    
                                    return `${context.dataset.label}: ${val}${suffix}`;
                                }
                            }
                        },
                        legend: { display: false },
                        annotation: {
                            annotations: {}
                        }
                    },
                    scales: {
                        y: {
                            type: 'logarithmic',
                            position: 'left',
                            title: { display: true, text: 'èµ„äº§ä»·æ ¼' },
                            ticks: { 
                                callback: function(value) {
                                    if(value === 0.1) return '0.1';
                                    if(value === 1) return '1';
                                    if(value === 10) return '10';
                                    if(value === 100) return '100';
                                    if(value === 1000) return '1k';
                                    if(value === 10000) return '10k';
                                    if(value === 100000) return '100k';
                                    return null;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'M2æ€»é‡' },
                            grid: { drawOnChartArea: false },
                            min: 0
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
            
            // Initial render
            switchCountry('cn'); 
        }

        function updateChart() {
            const data = currentCountry === 'cn' ? cnData : usData;
            const customRate = parseFloat(document.getElementById('inflationSlider').value);
            const isLog = document.getElementById('logScaleToggle').checked;
            const showHalving = document.getElementById('halvingToggle').checked && currentCountry === 'us';

            let infRates = [];
            if(currentMode === 'custom') infRates = new Array(years.length).fill(customRate);
            else if (currentMode === 'cpi') infRates = data.cpi_rates;
            else infRates = data.m2_rates;

            let datasets = [];

            // 1. M2 Background
            datasets.push({
                label: `M2æ€»é‡ (${data.m2_unit})`,
                data: data.m2_totals,
                borderColor: '#9CA3AF',
                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                borderWidth: 0,
                pointRadius: 0,
                fill: true,
                yAxisID: 'y1',
                order: 99
            });

            // 2. Assets
            data.assets.forEach(asset => {
                if (!asset.visible) return;

                const realData = calculateRealPrices(asset.data, infRates);
                
                // Nominal
                datasets.push({
                    label: `${asset.name}`,
                    data: asset.data,
                    borderColor: asset.color,
                    backgroundColor: asset.color,
                    borderWidth: 1.5,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    order: 10,
                    spanGaps: true
                });

                // Real
                datasets.push({
                    label: `${asset.name} (å®å€¼)`,
                    data: realData,
                    borderColor: asset.color,
                    backgroundColor: asset.color,
                    borderWidth: 3,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    order: 1,
                    spanGaps: true
                });
            });

            chartInstance.data.datasets = datasets;
            chartInstance.data.labels = years;
            
            chartInstance.options.scales.y.title.text = `ä»·æ ¼ (${data.unit})`;
            chartInstance.options.scales.y1.title.text = `M2æ€»é‡ (${data.m2_unit})`;
            chartInstance.options.scales.y.type = isLog ? 'logarithmic' : 'linear';

            // Annotations (Halving)
            const annotations = {};
            if (showHalving && data.halvingDates) {
                data.halvingDates.forEach((year, i) => {
                    annotations[`line${i}`] = {
                        type: 'line',
                        xMin: year,
                        xMax: year,
                        borderColor: 'rgba(249, 115, 22, 0.4)', // Orange
                        borderWidth: 2,
                        borderDash: [5, 5],
                        label: {
                            display: true,
                            content: `å‡åŠ ${year}`,
                            position: 'start',
                            backgroundColor: 'rgba(249, 115, 22, 0.7)',
                            color: 'white',
                            font: { size: 10 }
                        }
                    };
                });
            }
            chartInstance.options.plugins.annotation.annotations = annotations;

            chartInstance.update();

            document.getElementById('analysisContent').innerHTML = data.desc;
            
            const legendHTML = `
                <div class="flex items-center"><span class="w-3 h-3 bg-gray-300 mr-1"></span> M2æ€»é‡</div>
                <div class="flex items-center"><span class="w-3 h-1 border-t-2 border-dashed border-gray-400 mr-1"></span> åä¹‰ä»·</div>
                <div class="flex items-center"><span class="w-3 h-1 bg-gray-600 mr-1"></span> å®å€¼ (æ‰£é™¤${currentMode==='m2'?'M2':'é€šèƒ€'})</div>
            `;
            document.getElementById('customLegend').innerHTML = legendHTML;
        }

        const slider = document.getElementById('inflationSlider');
        const displayVal = document.getElementById('inflationValue');
        slider.addEventListener('input', (e) => {
            displayVal.innerText = parseFloat(e.target.value).toFixed(1) + '%';
            if(currentMode === 'custom') updateChart();
        });

        const logToggle = document.getElementById('logScaleToggle');
        logToggle.addEventListener('change', (e) => {
            updateChart();
        });
        
        const halvingToggle = document.getElementById('halvingToggle');
        halvingToggle.addEventListener('change', (e) => {
            updateChart();
        });

        // Initialize
        setTimeout(initChart, 100);

    </script>
</body>
</html>
