<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­ç¾æ ¸å¿ƒèµ„äº§ vs M2ï¼šç»ˆæå¯¹å†³ (2025å¯¹æ¯”ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: #2563EB; cursor: pointer; border-radius: 50%;
        }
        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        
        .radio-label input:checked + div {
            background-color: #EFF6FF; border-color: #2563EB; color: #1E40AF;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid #2563EB;
            color: #1D4ED8;
            background-color: #EFF6FF;
        }
        
        /* Custom scrollbar for info box */
        #infoContainer::-webkit-scrollbar { width: 4px; }
        #infoContainer::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center min-h-screen p-2 md:p-4">

    <!-- Header -->
    <header class="w-full max-w-7xl mb-4 text-center">
        <h1 class="text-xl md:text-3xl font-bold text-gray-900 mb-1">ä¸­ç¾èµ„äº§å¤§ä¹±æ–— (1980-2025)</h1>
        <p class="text-xs md:text-sm text-gray-500">
            <span class="bg-purple-100 text-purple-800 px-1 rounded">Update</span> ç¾å›½åŒºï¼šä¸Šæµ·æˆ¿ä»·å·²æŠ˜ç®—ä¸º USD/mÂ² | çœŸæ­£çš„ç¡¬é€šè´§PK
        </p>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-7xl space-y-6">
        
        <!-- SECTION 1: ASSETS VS M2 -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Country Tabs -->
            <div class="flex border-b border-gray-200">
                <button onclick="switchCountry('cn')" id="tab-cn" class="tab-btn active flex-1 py-4 text-center font-bold text-gray-500 hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                    <span class="text-xl">ğŸ‡¨ğŸ‡³</span> ä¸­å›½ (1980-2025)
                </button>
                <button onclick="switchCountry('us')" id="tab-us" class="tab-btn flex-1 py-4 text-center font-bold text-gray-500 hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                    <span class="text-xl">ğŸ‡ºğŸ‡¸</span> ç¾å›½ (1980-2025)
                </button>
            </div>

            <div class="p-3 md:p-5">
                <!-- Controls -->
                <div class="mb-5 grid grid-cols-1 lg:grid-cols-3 gap-4">
                    
                    <!-- Inflation Model -->
                    <div class="col-span-1 lg:col-span-2 bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <h3 class="text-sm font-bold text-gray-700 mb-2">é€‰æ‹©â€œæŠ˜ç®—æ ‡å‡†â€ (å»é™¤æ°´åˆ†)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <label class="radio-label cursor-pointer relative">
                                <input type="radio" name="infMode" value="cpi" class="sr-only" onchange="switchMode('cpi')">
                                <div class="border border-gray-300 rounded-md p-3 hover:bg-gray-50 h-full flex flex-col justify-between">
                                    <span class="font-bold text-sm">å®˜æ–¹ CPI</span>
                                    <p class="text-xs text-gray-500 mt-1">ä»…æ¶ˆè´¹å“ï¼Œé€šå¸¸ä½ä¼°ã€‚</p>
                                </div>
                            </label>
                            <label class="radio-label cursor-pointer relative">
                                <input type="radio" name="infMode" value="custom" class="sr-only" checked onchange="switchMode('custom')">
                                <div class="border border-gray-300 rounded-md p-3 hover:bg-gray-50 h-full flex flex-col justify-between">
                                    <span class="font-bold text-sm">è‡ªå®šä¹‰å›ºå®šå€¼</span>
                                    <p class="text-xs text-gray-500 mt-1">æ¨¡æ‹Ÿä½“æ„Ÿé€šèƒ€ã€‚</p>
                                </div>
                            </label>
                            <label class="radio-label cursor-pointer relative">
                                <input type="radio" name="infMode" value="m2" class="sr-only" onchange="switchMode('m2')">
                                <div class="border border-gray-300 rounded-md p-3 hover:bg-gray-50 h-full flex flex-col justify-between bg-purple-50 border-purple-200">
                                    <span class="font-bold text-sm text-purple-700">M2 å°é’é€Ÿåº¦</span>
                                    <p class="text-xs text-gray-500 mt-1 text-purple-600">èµ„äº§çš„ç»ˆææµ‹è¯•ã€‚è·‘èµ¢å®ƒæ‰ç®—çœŸèµšé’±ã€‚</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Slider / Log -->
                    <div class="col-span-1 bg-gray-50 border border-gray-200 rounded-lg p-3 flex flex-col justify-between">
                        <div id="sliderContainer">
                            <label class="block text-sm font-medium text-gray-700 mb-2 flex justify-between">
                                <span>è‡ªå®šä¹‰é€šèƒ€ç‡</span>
                                <span id="inflationValue" class="font-bold text-blue-600">5.5%</span>
                            </label>
                            <input type="range" id="inflationSlider" min="0" max="20" step="0.1" value="5.5" 
                                   class="w-full h-2 bg-blue-200 rounded-lg slider-thumb">
                        </div>
                        <div id="infoContainer" class="hidden text-xs text-gray-500 p-2 bg-white rounded border overflow-y-auto h-20"><p id="infoText"></p></div>
                        
                        <div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-200 bg-yellow-50 p-2 rounded">
                            <div class="flex items-center">
                                <span class="text-sm font-bold text-gray-800 mr-2">å¼€å¯å¯¹æ•°åæ ‡</span>
                                <div class="relative inline-block w-10 align-middle select-none">
                                    <input type="checkbox" id="logScaleToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                    <label for="logScaleToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            
                             <div class="flex items-center" id="halvingContainer">
                                <span class="text-sm font-bold text-orange-600 mr-2">æ˜¾ç¤ºBTCå‡åŠ</span>
                                <div class="relative inline-block w-10 align-middle select-none">
                                    <input type="checkbox" id="halvingToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                    <label for="halvingToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Asset Toggles -->
                <div id="assetToggles" class="mb-4 flex flex-wrap gap-2 text-sm select-none">
                    <!-- Dynamically populated checkboxes -->
                </div>

                <!-- Chart Container -->
                <div class="relative h-[400px] md:h-[550px] w-full">
                    <canvas id="housingChart"></canvas>
                </div>

                <!-- Legend -->
                <div class="mt-4 flex flex-wrap justify-center gap-4 text-xs text-gray-500" id="customLegend">
                    <!-- Dynamically populated -->
                </div>

                <!-- Analysis Box -->
                <div class="mt-5 p-4 bg-gray-100 rounded-lg border border-gray-300 text-sm">
                    <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <span id="analysisIcon">ğŸ“Š</span> 
                        <span id="analysisTitle">æ•°æ®è§£è¯»</span>
                    </h3>
                    <div id="analysisContent" class="text-gray-700 space-y-2 leading-relaxed">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: M2 COMPARISON -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden p-5">
            <h2 class="text-lg md:text-xl font-bold text-gray-900 mb-4 flex items-center">
                <span class="mr-2">ğŸ–¨ï¸</span> å…¨çƒå°é’æœºå¤§èµ›ï¼šM2 å¢é•¿æŒ‡æ•°å¯¹æ¯” (2000å¹´=100)
            </h2>
            <div class="relative h-[350px] w-full">
                <canvas id="m2CompChart"></canvas>
            </div>
            <div class="mt-3 text-xs text-gray-500 text-center">
                æ³¨ï¼šæ•°æ®ä¸ºå¹¿ä¹‰è´§å¸(M2)åä¹‰å€¼è¿‘ä¼¼ä¼°ç®—ã€‚ä¸­å›½M2æ‰©è¡¨é€Ÿåº¦è¿œè¶…ç¾æ—¥ã€‚
            </div>
        </div>

    </main>

    <script>
        // ==========================================
        // 1. DATA REPOSITORY (1980-2025)
        // ==========================================
        const years = Array.from({length: 46}, (_, i) => 1980 + i);

        // --- CHINA DATA (1980-2025) ---
        const cnDataRaw = {
            m2: [
                0.16, 0.20, 0.24, 0.29, 0.38, 0.52, 0.67, 0.83, 1.01, 1.20, // 80-89
                1.53, 1.93, 2.54, 3.49, 4.69, 6.08, 7.61, 9.10, // 90-97
                10.4, 11.9, 13.5, 15.8, 18.5, 22.1, 25.3, 29.8, 34.6, 40.3, 47.5, 60.6, // 98-09
                72.6, 85.2, 97.4, 110.6, 122.8, 139.2, 155.0, 167.7, 182.7, 198.6, // 10-19
                218.7, 238.3, 266.4, 292.3, 309.0, 335.0 // 20-25
            ],
            cpi: [
                6.0, 2.4, 1.9, 1.5, 2.8, 9.3, 6.5, 7.3, 18.8, 18.0, // 80-89 
                3.1, 3.4, 6.4, 14.7, 24.1, 17.1, 8.3, 2.8, // 90-97
                -0.8, -1.4, 0.4, 0.7, -0.8, 1.2, 3.9, 1.8, 1.5, 4.8, 5.9, -0.7, 
                3.3, 5.4, 2.6, 2.6, 2.0, 1.4, 2.0, 1.6, 2.1, 2.9, 
                2.5, 0.9, 2.0, 0.2, 0.3, 1.0
            ],
            // Housing
            sh: new Array(18).fill(null).concat([
                2300, 2450, 2900, 3500, 4200, 5100, 6500, 8800, 10500, 13000, 
                14500, 18000, 23000, 25500, 27000, 32000, 37000, 46000, 58000, 62000, 
                61000, 62000, 66000, 73000, 69000, 65000, 61000, 59000
            ]),
            cd: new Array(18).fill(null).concat([
                1800, 1900, 2100, 2300, 2600, 3100, 3800, 4500, 4800, 5500, 
                5200, 5800, 6500, 7200, 7500, 7800, 8200, 8500, 9800, 12000, 
                14500, 16000, 17500, 19000, 18500, 17800, 17000, 16800 
            ]),
            sh_comp: new Array(10).fill(null).concat([
                100, 292, 780, 833, 647, 555, 917, 1194, // 90-97
                1146, 1366, 2073, 1645, 1357, 1497, 1266, 1161, 2675, 5261, // 98-07
                1820, 3277, 2808, 2199, 2269, 2115, 3234, 3539, 3103, 3307, 
                2493, 3050, 3473, 3639, 3089, 2974, 2950, 3150
            ]),
            // Gold CNY/g -> Converted to CNY/oz
            gold_cny_oz: [
                28, 22, 19, 21, 18, 16, 20, 26, 28, 26, 
                27, 26, 25, 27, 30, 32, 33, 30,
                75, 78, 83, 89, 95, 105, 115, 125, 160, 190, 
                205, 245, 285, 330, 340, 270, 250, 235, 270, 275, 
                280, 315, 390, 375, 410, 480, 560, 620
            ].map(v => v * 31.1),
            // Silver CNY/oz
            silver_cny_oz: [
                1.0, 0.5, 0.4, 0.5, 0.4, 0.3, 0.3, 0.4, 0.4, 0.4, 
                0.3, 0.3, 0.3, 0.4, 0.5, 0.5, 0.5, 0.5, 
                1.5, 1.4, 1.4, 1.3, 1.3, 1.4, 1.8, 2.0, 3.5, 3.8, 
                3.5, 4.0, 6.0, 8.5, 6.5, 4.2, 3.8, 3.5, 4.0, 3.9, 
                3.6, 4.0, 5.5, 4.8, 4.5, 5.5, 6.5, 12.0
            ].map(v => v * 31.1),
            // USD/CNY Exchange Rate
            usd_cny: [
                1.5, 1.7, 1.9, 1.9, 2.3, 2.9, 3.4, 3.7, 3.7, 3.7, // 80-89
                4.7, 5.3, 5.7, 5.7, 8.6, 8.3, 8.3, 8.2, // 90-97 (94 Devaluation)
                8.2, 8.2, 8.2, 8.2, 8.2, 8.2, 8.2, 8.1, 7.9, 7.6, 
                6.9, 6.8, 6.7, 6.4, 6.3, 6.1, 6.1, 6.2, 6.6, 6.7, 
                6.6, 6.9, 6.9, 6.4, 6.7, 7.0, 7.1, 7.2 // 98-25
            ]
        };
        
        // BTC Data
        const btc_usd = [0.1, 5, 13, 700, 320, 430, 960, 14000, 3700, 7200, 29000, 47000, 16000, 42000, 95000, 145000];
        const btc_padded_cn = new Array(30).fill(null).concat(btc_usd.map(v => v * 7.1));
        const btc_padded_us = new Array(30).fill(null).concat(btc_usd);

        const cnData = {
            m2_totals: cnDataRaw.m2,
            m2_rates: [0].concat(cnDataRaw.m2.slice(1).map((v, i) => ((v - cnDataRaw.m2[i])/cnDataRaw.m2[i])*100)),
            cpi_rates: cnDataRaw.cpi,
            assets: [
                { name: 'ä¸Šæµ·æˆ¿ä»·', color: '#7C3AED', data: cnDataRaw.sh, visible: true },
                { name: 'æˆéƒ½æˆ¿ä»·', color: '#0EA5E9', data: cnDataRaw.cd, visible: true }, 
                { name: 'ä¸Šè¯æŒ‡æ•° (å¤§A)', color: '#DB2777', data: cnDataRaw.sh_comp, visible: true },
                { name: 'é»„é‡‘ (CNY/oz)', color: '#EAB308', data: cnDataRaw.gold_cny_oz, visible: true },
                { name: 'ç™½é“¶ (CNY/oz)', color: '#94A3B8', data: cnDataRaw.silver_cny_oz, visible: true },
                { name: 'BTC (CNYè®¡ä»·)', color: '#F97316', data: btc_padded_cn, visible: true },
                { name: 'USD/CNYæ±‡ç‡', color: '#10B981', data: cnDataRaw.usd_cny, visible: true, borderDash: [5,5] } 
            ],
            unit: 'ä»·æ ¼/ç‚¹æ•°/æ±‡ç‡',
            m2_unit: 'ä¸‡äº¿äººæ°‘å¸',
            desc: '<ul class="list-disc pl-4 space-y-1"><li><strong>æ±‡ç‡ä¹‹è°œ (ç»¿è‰²è™šçº¿)ï¼š</strong>çœ‹å›¾ä¸­æœ€å¹³ç¼“çš„é‚£æ¡çº¿â€”â€”æ±‡ç‡ã€‚å°½ç®¡M2ï¼ˆç°è‰²èƒŒæ™¯ï¼‰ç¿»äº†å‡ åå€ï¼Œä½†äººæ°‘å¸æ±‡ç‡ä»…ä»1.5è´¬å€¼åˆ°7.2ã€‚è¿™è¯´æ˜è¶…å‘çš„è´§å¸ä¸»è¦è¢«<strong>æˆ¿åœ°äº§ï¼ˆç´«çº¿/è“çº¿ï¼‰</strong>å’Œ<strong>ç»æµå¢é•¿</strong>å¸æ”¶äº†ï¼Œè¡¨ç°ä¸ºâ€œå¯¹å†…èµ„äº§ä»·æ ¼è´¬å€¼ï¼ˆæˆ¿ä»·æ¶¨ï¼‰â€ï¼Œè€Œç»´æŒäº†â€œå¯¹å¤–æ±‡ç‡ç›¸å¯¹ç¨³å®šâ€ã€‚è¿™å°±æ˜¯â€œè“„æ°´æ± â€æ•ˆåº”ã€‚</li><li><strong>é»„é‡‘ (é»„çº¿)ï¼š</strong>é»„é‡‘ä»·æ ¼çš„é•¿æœŸä¸Šæ¶¨ï¼Œå…¶å®å°±æ˜¯äººæ°‘å¸è´­ä¹°åŠ›ä¸‹é™çš„çœŸå®é•œåƒã€‚</li></ul>',
            halvingDates: [2012, 2016, 2020, 2024]
        };

        // --- CALC SHANGHAI IN USD/SQM ---
        const sh_cny = cnDataRaw.sh;
        const rates = cnDataRaw.usd_cny;
        const sh_usd_sqm = sh_cny.map((val, i) => val !== null ? val / rates[i] : null);

        // --- US DATA (1980-2025) ---
        const usData = {
            m2_totals: [
                1.6, 1.75, 1.95, 2.18, 2.37, 2.57, 2.81, 2.91, 3.06, 3.22, 
                3.34, 3.44, 3.55, 3.63, 3.68, 3.82, 4.02, 4.22, 4.40, 4.60, 
                4.92, 5.43, 5.78, 6.05, 6.41, 6.68, 7.04, 7.45, 8.16, 8.52, 
                8.82, 9.63, 10.42, 11.05, 11.64, 12.32, 13.19, 13.93, 14.53, 15.32, 
                19.12, 21.43, 21.31, 20.88, 21.10, 21.95 
            ],
            cpi_rates: [
                13.5, 10.3, 6.1, 3.2, 4.3, 3.6, 1.9, 3.6, 4.1, 4.8,
                5.4, 4.2, 3.0, 3.0, 2.6, 2.8, 3.0, 2.3, 1.6, 2.2,
                3.4, 2.8, 1.6, 2.3, 2.7, 3.4, 3.2, 2.8, 3.8, -0.4,
                1.6, 3.2, 2.1, 1.5, 1.6, 0.1, 1.3, 2.1, 2.4, 1.8,
                1.2, 4.7, 8.0, 4.1, 3.1, 2.3
            ],
            assets: [
                { 
                    name: 'S&P 500', 
                    color: '#16A34A', 
                    visible: true,
                    data: [ 
                        135, 122, 140, 164, 167, 211, 242, 247, 277, 353,
                        330, 417, 435, 466, 459, 615, 740, 970, 1229, 1469,
                        1320, 1148, 879, 1111, 1211, 1248, 1418, 1468, 903, 1115,
                        1257, 1257, 1426, 1848, 2058, 2043, 2238, 2673, 2506, 3230,
                        3756, 4766, 3839, 4769, 5950, 6200 
                    ] 
                },
                {
                    name: 'é»„é‡‘ (USD/oz)',
                    color: '#EAB308', 
                    visible: true, 
                    data: [ 
                        612, 460, 376, 424, 360, 317, 368, 447, 437, 381,
                        383, 362, 343, 359, 384, 384, 387, 331, 294, 278,
                        279, 271, 310, 363, 409, 444, 603, 695, 871, 972,
                        1224, 1571, 1669, 1411, 1266, 1160, 1250, 1257, 1268, 1393,
                        1769, 1798, 1800, 1940, 2350, 2750
                    ]
                },
                {
                    name: 'ç™½é“¶ (USD/oz)', 
                    color: '#94A3B8',
                    visible: true, 
                    data: [
                        20.9, 10.5, 7.9, 11.4, 8.1, 6.1, 5.4, 7.0, 6.5, 5.5,
                        4.8, 4.0, 3.9, 4.3, 5.3, 5.2, 5.1, 4.8, 5.5, 5.2,
                        4.9, 4.3, 4.6, 4.8, 6.6, 7.3, 11.5, 13.3, 14.9, 14.6,
                        20.1, 35.1, 31.1, 23.7, 19.0, 15.6, 17.1, 17.0, 15.7, 16.2,
                        20.5, 25.1, 21.7, 23.3, 30.0, 58.0
                    ]
                },
                {
                    name: 'å…¨ç¾æˆ¿ä»·(æŒ‡æ•°)', 
                    color: '#0891B2', 
                    visible: true, 
                    data: [
                        650, 690, 710, 750, 800, 850, 920, 1050, 1120, 1200,
                        1250, 1220, 1240, 1280, 1330, 1380, 1420, 1490, 1580, 1650,
                        1720, 1800, 1950, 2100, 2300, 2500, 2400, 2300, 2100, 2200,
                        2250, 2300, 2450, 2650, 2800, 2950, 3100, 3250, 3300, 3350,
                        3400, 3800, 4400, 4200, 4250, 4280
                    ]
                },
                {
                    // ADDED: Shanghai Housing converted to USD/sqm
                    name: 'ä¸­å›½ä¸Šæµ·æˆ¿ä»· (USD/mÂ²)', 
                    color: '#7C3AED', 
                    visible: true, 
                    data: sh_usd_sqm,
                    borderDash: [5, 5] // Dashed to distinguish foreign asset
                },
                {
                    name: 'Apple (AAPL)',
                    color: '#000000', 
                    visible: true,
                    data: [
                        0.13, 0.09, 0.08, 0.12, 0.10, 0.07, 0.11, 0.15, 0.14, 0.13,
                        0.14, 0.18, 0.20, 0.13, 0.14, 0.15, 0.09, 0.06, 0.15, 0.35,
                        0.38, 0.39, 0.25, 0.33, 0.90, 1.6, 2.3, 5.5, 3.5, 6.5,
                        10.0, 13.0, 17.0, 18.0, 25.0, 27.0, 28.0, 40.0, 38.0, 70.0,
                        130.0, 175.0, 130.0, 190.0, 225.0, 280.0
                    ]
                },
                {
                    name: 'Tesla (TSLA)',
                    color: '#E31937', 
                    visible: true,
                    data: new Array(30).fill(null).concat([
                        1.5, 1.7, 2.0, 6.0, 10.0, 15.0, 14.0, 20.0, 21.0, 28.0, // 2010-2019
                        150.0, 350.0, 120.0, 250.0, 210.0, 350.0 // 2020-2025
                    ])
                },
                {
                    name: 'Nvidia (NVDA)',
                    color: '#76B900', 
                    visible: true,
                    data: new Array(19).fill(null).concat([
                        0.1, 0.2, 0.4, 0.2, 0.3, 0.4, 0.6, 0.8, 1.0, 0.5, // 1999-2008
                        0.8, 1.0, 0.9, 0.8, 1.0, 1.2, 2.0, // 2009-2015
                        6.0, 10.0, 7.0, 15.0, 35.0, 80.0, 40.0, 120.0, 150.0, 180.0 // 2016-2025
                    ])
                },
                {
                    name: 'BTC (æ¯”ç‰¹å¸)',
                    color: '#F97316', 
                    visible: true,
                    data: btc_padded_us
                }
            ],
            unit: 'ä»·æ ¼/ç‚¹æ•°',
            m2_unit: 'ä¸‡äº¿ç¾å…ƒ',
            desc: '<ul class="list-disc pl-4 space-y-1"><li><strong>ä¸­ç¾æˆ¿äº§å¤§PK (ç´«è‰²è™šçº¿ vs è“è‰²å®çº¿)ï¼š</strong>é€šè¿‡å°†ä¸Šæµ·æˆ¿ä»·æ¢ç®—ä¸º<strong>ç¾å…ƒ/å¹³ç±³ (USD/mÂ²)</strong>ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæƒŠäººçš„å¯¹æ¯”ã€‚åœ¨2000-2015å¹´é—´ï¼Œä¸Šæµ·æˆ¿ä»·çš„æ–œç‡ï¼ˆç´«è‰²ï¼‰è¿œè¶…ç¾å›½æˆ¿ä»·ï¼ˆè“è‰²ï¼‰ã€‚ä¸Šæµ·æˆ¿ä»·ä»æœ€åˆçš„ä¸åˆ°$300/å¹³ç±³ï¼Œä¸€è·¯é£™å‡è‡³$8,000+/å¹³ç±³ï¼Œè€Œç¾å›½æˆ¿ä»·æŒ‡æ•°åˆ™æ˜¾å¾—éå¸¸â€œæ¸©å’Œâ€ã€‚</li><li><strong>ç¡¬é€šè´§è§†è§’ï¼š</strong>å³ä¾¿ä»¥ç¾å…ƒè®¡ä»·ï¼Œä¸­å›½ä¸€çº¿åŸå¸‚çš„æˆ¿äº§åœ¨è¿‡å»20å¹´ä¹Ÿæ˜¯å…¨çƒè¡¨ç°æœ€å¥½çš„å¤§ç±»èµ„äº§ä¹‹ä¸€ï¼Œç›´åˆ°è¿‘å‡ å¹´æ‰å¼€å§‹å›è°ƒã€‚</li></ul>',
            halvingDates: [2012, 2016, 2020, 2024]
        };
        
        // Calc US M2 Rates
        usData.m2_rates = [0]; 
        for(let i=1; i<usData.m2_totals.length; i++) {
            usData.m2_rates.push( ((usData.m2_totals[i] - usData.m2_totals[i-1])/usData.m2_totals[i-1]) * 100 );
        }

        // ==========================================
        // 2. STATE & LOGIC
        // ==========================================
        if (window['chartjs-plugin-annotation']) {
            Chart.register(window['chartjs-plugin-annotation']);
        }

        let currentCountry = 'cn'; 
        let currentMode = 'custom'; 
        let chartInstance = null;
        let m2ChartInstance = null;

        function switchCountry(code) {
            currentCountry = code;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${code}`).classList.add('active');
            
            renderToggles();
            updateChart();
        }

        function switchMode(mode) {
            currentMode = mode;
            const slider = document.getElementById('sliderContainer');
            const info = document.getElementById('infoContainer');
            const infoText = document.getElementById('infoText');

            if (mode === 'custom') {
                slider.classList.remove('hidden');
                info.classList.add('hidden');
            } else {
                slider.classList.add('hidden');
                info.classList.remove('hidden');
                infoText.innerHTML = mode === 'cpi' 
                    ? `ä½¿ç”¨${currentCountry.toUpperCase()}å®˜æ–¹CPIæ•°æ®ã€‚<br>ä»…åæ˜ åŸºæœ¬ç”Ÿæ´»ç‰©ä»·ã€‚`
                    : `ä½¿ç”¨${currentCountry.toUpperCase()} M2å¹¿ä¹‰è´§å¸å¢é€Ÿã€‚<br>è¿™æ˜¯"èµ„äº§ä¿å€¼"çš„ç»ˆæåŠæ ¼çº¿ã€‚`;
            }
            updateChart();
        }

        function renderToggles() {
            const data = currentCountry === 'cn' ? cnData : usData;
            const container = document.getElementById('assetToggles');
            container.innerHTML = '';
            
            data.assets.forEach((asset, index) => {
                const id = `toggle_${index}`;
                const wrapper = document.createElement('div');
                wrapper.className = "flex items-center mr-4 mb-2";
                
                wrapper.innerHTML = `
                    <input type="checkbox" id="${id}" ${asset.visible ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 cursor-pointer">
                    <label for="${id}" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer flex items-center select-none">
                        <span class="w-3 h-3 rounded-full mr-1 inline-block" style="background-color:${asset.color}"></span>
                        ${asset.name}
                    </label>
                `;
                
                wrapper.querySelector('input').addEventListener('change', (e) => {
                    data.assets[index].visible = e.target.checked;
                    updateChart();
                });
                
                container.appendChild(wrapper);
            });
        }

        function calculateRealPrices(priceArray, inflationRates) {
            const len = priceArray.length;
            const adjusted = new Array(len).fill(null);
            
            let lastIdx = len - 1;
            while(lastIdx >= 0 && priceArray[lastIdx] === null) lastIdx--;
            if(lastIdx < 0) return adjusted;

            let factor = 1.0;
            adjusted[lastIdx] = priceArray[lastIdx];

            for (let i = lastIdx - 1; i >= 0; i--) {
                if (priceArray[i] === null) continue;
                let rate = 0;
                if(inflationRates[i+1] !== null) {
                    rate = inflationRates[i+1] / 100.0;
                }
                factor = factor * (1 + rate);
                adjusted[i] = priceArray[i] * factor;
            }
            return adjusted;
        }

        // ==========================================
        // 3. CHART RENDERING (MAIN CHART)
        // ==========================================
        function initChart() {
            const ctx = document.getElementById('housingChart').getContext('2d');
            
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: years, datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e5e7eb', borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const data = currentCountry === 'cn' ? cnData : usData;
                                    if (context.dataset.yAxisID === 'y1') {
                                        return `M2æ€»é‡: ${context.raw.toLocaleString()} ${data.m2_unit}`;
                                    }
                                    let val = context.raw;
                                    if(val > 1000) val = Math.round(val).toLocaleString();
                                    else if(val) val = val.toFixed(2);
                                    
                                    let suffix = '';
                                    if(context.dataset.label.includes('æˆ¿ä»·') && currentCountry === 'us' && !context.dataset.label.includes('ä¸Šæµ·')) suffix = ' (æŒ‡æ•°)';
                                    
                                    return `${context.dataset.label}: ${val}${suffix}`;
                                }
                            }
                        },
                        legend: { display: false },
                        annotation: { 
                            annotations: [] 
                        }
                    },
                    scales: {
                        y: {
                            type: 'logarithmic',
                            position: 'left',
                            title: { display: true, text: 'èµ„äº§ä»·æ ¼' },
                            ticks: { 
                                callback: function(value) {
                                    if([0.1, 1, 10, 100, 1000, 10000, 100000, 1000000].includes(value)) {
                                        if(value>=1000) return (value/1000) + 'k';
                                        return value;
                                    }
                                    return null;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'M2æ€»é‡' },
                            grid: { drawOnChartArea: false },
                            min: 0
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
            
            switchCountry('cn'); 
        }

        function updateChart() {
            const data = currentCountry === 'cn' ? cnData : usData;
            const customRate = parseFloat(document.getElementById('inflationSlider').value);
            const isLog = document.getElementById('logScaleToggle').checked;
            const showHalving = document.getElementById('halvingToggle').checked;

            let infRates = [];
            if(currentMode === 'custom') infRates = new Array(years.length).fill(customRate);
            else if (currentMode === 'cpi') infRates = data.cpi_rates;
            else infRates = data.m2_rates;

            let datasets = [];

            // 1. M2 Background
            datasets.push({
                label: `M2æ€»é‡ (${data.m2_unit})`,
                data: data.m2_totals,
                borderColor: '#9CA3AF',
                backgroundColor: 'rgba(156, 163, 175, 0.1)',
                borderWidth: 0,
                pointRadius: 0,
                fill: true,
                yAxisID: 'y1',
                order: 99
            });

            // 2. Assets
            data.assets.forEach(asset => {
                if (!asset.visible) return;

                const realData = calculateRealPrices(asset.data, infRates);
                
                // Nominal
                datasets.push({
                    label: `${asset.name}`,
                    data: asset.data,
                    borderColor: asset.color,
                    backgroundColor: asset.color,
                    borderWidth: 1.5,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    order: 10,
                    spanGaps: true,
                    // Dashed for USD/CNY to distinguish
                    borderDash: asset.borderDash || [3, 3] 
                });

                // Real
                datasets.push({
                    label: `${asset.name} (å®å€¼)`,
                    data: realData,
                    borderColor: asset.color,
                    backgroundColor: asset.color,
                    borderWidth: 3,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    order: 1,
                    spanGaps: true
                });
            });

            chartInstance.data.datasets = datasets;
            chartInstance.data.labels = years;
            chartInstance.options.scales.y.title.text = `ä»·æ ¼ (${data.unit})`;
            chartInstance.options.scales.y1.title.text = `M2æ€»é‡ (${data.m2_unit})`;
            chartInstance.options.scales.y.type = isLog ? 'logarithmic' : 'linear';

            // Annotations (Halving)
            const newAnnotations = [];
            if (showHalving && data.halvingDates) {
                data.halvingDates.forEach((year, i) => {
                    newAnnotations.push({
                        type: 'line',
                        scaleID: 'x',
                        value: year,
                        borderColor: 'rgba(249, 115, 22, 0.6)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        label: {
                            display: true,
                            content: `å‡åŠ ${year}`,
                            position: 'start',
                            backgroundColor: 'rgba(249, 115, 22, 0.8)',
                            color: 'white',
                            font: { size: 10 },
                            yAdjust: 0
                        }
                    });
                });
            }
            chartInstance.options.plugins.annotation.annotations = newAnnotations;
            
            chartInstance.update();

            document.getElementById('analysisContent').innerHTML = data.desc;
            
            const legendHTML = `
                <div class="flex items-center"><span class="w-3 h-3 bg-gray-300 mr-1"></span> M2æ€»é‡</div>
                <div class="flex items-center"><span class="w-3 h-1 border-t-2 border-dashed border-gray-400 mr-1"></span> åä¹‰ä»·</div>
                <div class="flex items-center"><span class="w-3 h-1 bg-gray-600 mr-1"></span> å®å€¼ (æ‰£é™¤${currentMode==='m2'?'M2':'é€šèƒ€'})</div>
            `;
            document.getElementById('customLegend').innerHTML = legendHTML;
        }

        const slider = document.getElementById('inflationSlider');
        const displayVal = document.getElementById('inflationValue');
        slider.addEventListener('input', (e) => {
            displayVal.innerText = parseFloat(e.target.value).toFixed(1) + '%';
            if(currentMode === 'custom') updateChart();
        });

        const logToggle = document.getElementById('logScaleToggle');
        logToggle.addEventListener('change', (e) => {
            updateChart();
        });
        
        const halvingToggle = document.getElementById('halvingToggle');
        halvingToggle.addEventListener('change', (e) => {
            updateChart();
        });

        // ==========================================
        // 4. CHART RENDERING (M2 COMPARISON)
        // ==========================================
        function initM2CompChart() {
            const startYear = 2000;
            const startIndex = 20; // 2000 is index 20 (since start 1980)
            const years2000 = years.slice(startIndex);
            
            function getIndexedData(dataArr) {
                const baseVal = dataArr[startIndex];
                if(!baseVal) return [];
                return dataArr.slice(startIndex).map(v => (v / baseVal) * 100);
            }

            const cnM2Indexed = getIndexedData(cnDataRaw.m2);
            const usM2Indexed = getIndexedData(usData.m2_totals);
            
            // Japan proxy: ~2% growth avg
            const jpM2Indexed = years2000.map((y, i) => 100 * Math.pow(1.025, i));

            const ctx = document.getElementById('m2CompChart').getContext('2d');
            m2ChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years2000,
                    datasets: [
                        {
                            label: 'ğŸ‡¨ğŸ‡³ ä¸­å›½ M2',
                            data: cnM2Indexed,
                            borderColor: '#DC2626',
                            backgroundColor: '#DC2626',
                            borderWidth: 3,
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: 'ğŸ‡ºğŸ‡¸ ç¾å›½ M2',
                            data: usM2Indexed,
                            borderColor: '#2563EB',
                            backgroundColor: '#2563EB',
                            borderWidth: 3,
                            pointRadius: 0,
                            tension: 0.3
                        },
                        {
                            label: 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬ M2',
                            data: jpM2Indexed,
                            borderColor: '#9CA3AF',
                            backgroundColor: '#9CA3AF',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${Math.round(context.raw)}`;
                                }
                            }
                        },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'å¢é•¿æŒ‡æ•° (2000å¹´=100)' },
                            type: 'linear'
                        }
                    }
                }
            });
        }

        // Initialize
        setTimeout(() => {
            initChart();
            initM2CompChart();
        }, 100);

    </script>
</body>
</html>
